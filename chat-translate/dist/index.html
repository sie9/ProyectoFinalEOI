<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ejercicio</title>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-sm">
                <div class="users_connected">
                    <div class="card" style="width: 18rem;">
                        <a href="#" onclick="inicia_chat(usuario)" class="btn btn-secondary">
                            <img class="card-img-top" alt="Foto Usuario">
                            <p class="card-text">Nombre Usuario</p>
                            <p id="language" class="card-text">Idioma</p>
                        </a>
                    </div>

                    <h2>Usuarios conectados</h2>
                </div>
            </div>
            <div class="col-sm">
                <div class="chat">
                    <div class="card" style="width: 18rem;">
                        <div class="card-header">
                            <div class="card" style="width: 18rem;">
                                <img class="card-img-top" alt="Foto Usuario">
                                <p id="username" class="card-text">Christian</p>
                                <p id="idiomareceiver" class="card-text">en</p>
                            </div>
                        </div>
                        <ul class="list-group list-group-flush" id="chat">
                        </ul>
                        <div class="input-group">
                            <input id="message" type="text" class="form-control" placeholder="Introduzca mensaje" aria-label="Recipient's username" aria-describedby="basic-addon2">
                            <div class="input-group-append">
                                <button id="enviar" class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-comment"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm">
                <div class="user">
                    <div class="card" style="width: 18rem;">
                        <img class="card-img-top" alt="Foto Usuario">
                        <p id="my--username" class="card-text">DAvid</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"></script>
    <script defer src="http://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>
    <script src="main.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.5/lodash.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyAjSmxX192rX49siXmeyFPE-I9fe9qnp3k",
            authDomain: "webproject-1521542085650.firebaseapp.com",
            databaseURL: "https://webproject-1521542085650.firebaseio.com",
            projectId: "webproject-1521542085650",
            storageBucket: "",
            messagingSenderId: "765976181424"
        };
        firebase.initializeApp(config);


        var db = firebase.database();
        $('#enviar').on('click', function () {
            var mensaje = $('#message').val();
            db.ref('mensajes').push({
                mensaje: mensaje,
                sender: "DAvid",
                receiver: "Christian"
            });
            $('#message').val('');
        })



        $(document).ready(function () {
            var me = $('#my--username').text();
            var other = $('#username').text();
            var otherlanguage = $('#idiomareceiver').text();
            db.ref('mensajes').on('child_added', function (data) {
                console.log(data.val().mensaje);
                let objText = {
                    text: data.val().mensaje,
                    language: otherlanguage
                }


                // $.ajax("http://localhost:5600/api/translate", {
                //     data: JSON.stringify(objText),
                //     contentType: 'application/json',
                //     type: 'POST'
                // }).done(res => {
                //     console.log('respuesta', res);

                // });

                if ((data.val().sender === me) && (data.val().receiver === other)) {
                    $.post("http://localhost:5600/api/translate", objText).then(res => {
                        console.log('respuesta', res);

                        $('#chat').append('<li class="list-group-item bg-primary" >' + res  + '</li>');

                    }
                    ).catch(err => console.log('err', err));

                }
                if ((data.val().sender === other) && (data.val().receiver === me)) {
                    $.post("http://localhost:5600/api/translate", objText).then(res => {
                        console.log('respuesta', res);
                        $('#chat').append('<li class="list-group-item bg-success" >' + res + '</li>');

                    }
                    ).catch(err => console.log('err', err));
                    
                    
                    
                }




                /*  var chat=data.find(u => u.sender===me);
                 chat=chat.find(u=>u.receiver==other); */

            });
        });
    </script>
</body>

</html>